<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¿ä¸œåŠ©æ‰‹ v5.0 - åŠ æƒåˆ†æ‘Šä¿®æ­£ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .transition-all { transition: all 0.3s ease; }
    </style>
</head>
<body>

<div id="app" class="container mx-auto p-4 max-w-5xl">
    
    <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-500">
        <h1 class="text-xl font-bold text-gray-800">
            <i class="fas fa-home text-blue-600 mr-2"></i> æˆ¿ä¸œåŠ©æ‰‹ (4å®¤)
        </h1>
        <div class="space-x-2 text-sm">
            <button @click="downloadData" class="text-blue-600 hover:bg-blue-50 px-3 py-1 rounded transition-all">
                <i class="fas fa-download mr-1"></i>å¤‡ä»½
            </button>
            <button @click="$refs.fileInput.click()" class="text-gray-600 hover:bg-gray-100 px-3 py-1 rounded transition-all">
                <i class="fas fa-upload mr-1"></i>æ¢å¤
            </button>
            <input type="file" ref="fileInput" @change="uploadData" style="display:none" accept=".json">
        </div>
    </div>

    <div class="grid grid-cols-3 gap-4 mb-8">
        <div class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-green-500">
            <div class="text-gray-500 text-sm font-semibold mb-1">æ€»æˆ¿ç§Ÿæ”¶å…¥</div>
            <div class="text-2xl font-bold text-gray-800">Â¥{{ totalIncome | numberFormat }}</div>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-red-500">
            <div class="text-gray-500 text-sm font-semibold mb-1">æˆ¿ä¸œæ€»æ”¯å‡º (ç»´ä¿®ç­‰)</div>
            <div class="text-2xl font-bold text-gray-800">Â¥{{ totalExpense | numberFormat }}</div>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-blue-500 relative overflow-hidden">
            <div class="text-gray-500 text-sm font-semibold mb-1">çº¯å‡€æ”¶ç›Š</div>
            <div class="text-3xl font-bold text-blue-600">Â¥{{ (totalIncome - totalExpense) | numberFormat }}</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        
        <div class="lg:col-span-2 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div v-for="(room, index) in rooms" :key="index" class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 relative">
                    <div class="flex justify-between items-start mb-3">
                        <div class="font-bold text-lg text-gray-800">{{ room.name }}</div>
                        <span :class="room.tenant ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'" class="px-2 py-1 rounded text-xs font-bold">
                            {{ room.tenant ? 'å·²å‡ºç§Ÿ' : 'å¾…ç§Ÿ' }}
                        </span>
                    </div>

                    <div v-if="room.tenant" class="space-y-1 text-sm text-gray-600">
                        <p>ğŸ‘¤ ç§Ÿå®¢: <strong class="text-gray-900">{{ room.tenant }}</strong></p>
                        <p>ğŸ’° ç§Ÿé‡‘: Â¥{{ room.rent }}/æœˆ</p>
                        <p>ğŸ“… å…¥ä½: <strong class="text-gray-900">{{ room.startDate }}</strong></p>
                        <p class="text-blue-600 bg-blue-50 inline-block px-2 rounded mt-1">â° ä¸‹æ¬¡æ”¶ç§Ÿ: {{ getNextPayDate(room.startDate) }}</p>
                        
                        <div class="flex space-x-2 mt-4 pt-3 border-t">
                            <button @click="editRoom(index)" class="flex-1 bg-gray-50 hover:bg-gray-200 text-gray-600 py-1.5 rounded text-xs">ç¼–è¾‘</button>
                            <button @click="openRentModal(index)" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-1.5 rounded text-xs shadow">ç™»è®°æ”¶ç§Ÿ</button>
                            <button @click="openCheckoutModal(index)" class="flex-1 bg-red-50 hover:bg-red-100 text-red-600 py-1.5 rounded text-xs">é€€ç§Ÿç»“ç®—</button>
                        </div>
                    </div>

                    <div v-else class="h-32 flex items-center justify-center">
                        <button @click="editRoom(index)" class="border-2 border-dashed border-gray-300 text-gray-400 px-4 py-2 rounded hover:border-blue-500 hover:text-blue-500 transition-colors">
                            <i class="fas fa-plus mr-1"></i> åŠç†å…¥ä½
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-1 space-y-6">
            
            <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-100 h-fit">
                <h2 class="text-lg font-bold text-gray-700 mb-4 flex items-center">
                    <i class="fas fa-calculator mr-2 text-indigo-500"></i> ç§Ÿå®¢è´¹ç”¨åˆ†æ‘Š (æ°´/æ°”/ç‰©ä¸š)
                </h2>
                <p class="text-xs text-gray-400 mb-4">éœ€è¾“å…¥è´¦å•å‘¨æœŸï¼ŒæŒ‰å…¥ä½å¤©æ•°**åŠ æƒå‡æ‘Š**ã€‚</p>
                
                <div class="space-y-3">
                    <div class="flex space-x-2 bg-gray-100 p-1 rounded-lg">
                        <button @click="newBill.type = 'æ°´è´¹'" :class="newBill.type === 'æ°´è´¹' ? 'bg-white shadow text-blue-600' : 'text-gray-500'" class="flex-1 py-1.5 rounded text-sm transition-all">æ°´è´¹</button>
                        <button @click="newBill.type = 'ç‡ƒæ°”è´¹'" :class="newBill.type === 'ç‡ƒæ°”è´¹' ? 'bg-white shadow text-yellow-600' : 'text-gray-500'" class="flex-1 py-1.5 rounded text-sm transition-all">ç‡ƒæ°”è´¹</button>
                        <button @click="newBill.type = 'ç‰©ä¸šè´¹'" :class="newBill.type === 'ç‰©ä¸šè´¹' ? 'bg-white shadow text-indigo-600' : 'text-gray-500'" class="flex-1 py-1.5 rounded text-sm transition-all">ç‰©ä¸šè´¹</button>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">è´¦å•è®°å½•æ—¥æœŸ</label>
                        <input type="date" v-model="newBill.date" class="w-full border p-2 rounded mt-1">
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">å‘¨æœŸå¼€å§‹ (å«)</label>
                            <input type="date" v-model="newBill.billingStartDate" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">å‘¨æœŸç»“æŸ (ä¸å«)</label>
                            <input type="date" v-model="newBill.billingEndDate" class="w-full border p-2 rounded">
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-500">æ€»é‡‘é¢</label>
                        <input type="number" v-model.number="newBill.amount" class="w-full border p-2 rounded mt-1 font-mono text-lg" placeholder="0.00">
                    </div>

                    <div class="bg-indigo-50 p-3 rounded border border-indigo-100">
                        <label class="text-xs font-bold text-indigo-800 mb-2 block">å‚ä¸åˆ†æ‘Šæˆ¿é—´ (è‡ªåŠ¨é€‰å·²å…¥ä½)</label>
                        <div class="space-y-1 max-h-32 overflow-y-auto">
                            <label v-for="(room) in rooms" :key="room.name" class="flex items-center space-x-2 cursor-pointer hover:bg-white/50 p-1 rounded">
                                <input type="checkbox" v-model="newBill.sharedBy" :value="room.name" class="accent-indigo-600" :disabled="!room.tenant">
                                <span class="text-sm">{{ room.name }} <span v-if="room.tenant" class="text-xs text-gray-500">({{ room.tenant }})</span><span v-else class="text-xs text-red-400">(å¾…ç§Ÿ)</span></span>
                            </label>
                        </div>
                    </div>

                    <button @click="addBill" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded shadow font-medium transition-transform active:scale-95">
                        ç”Ÿæˆåˆ†æ‘Šè´¦å•
                    </button>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-lg border border-red-100 h-fit">
                <h2 class="text-lg font-bold text-gray-700 mb-4 flex items-center">
                    <i class="fas fa-tools mr-2 text-red-500"></i> æˆ¿ä¸œç»´ä¿®æ”¯å‡º (è®¡å…¥æˆæœ¬)
                </h2>
                <p class="text-xs text-red-400 mb-4">æ­¤è´¹ç”¨ä¼šæ‰£å‡æ‚¨çš„çº¯å‡€æ”¶ç›Šã€‚</p>
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500">æ”¯å‡ºæ—¥æœŸ</label>
                        <input type="date" v-model="newExpense.date" class="w-full border p-2 rounded mt-1">
                    </div>
                    
                    <div>
                        <label class="text-xs font-bold text-gray-500">æ¶‰åŠæˆ¿é—´</label>
                        <select v-model="newExpense.roomName" class="w-full border p-2 rounded mt-1">
                            <option value="">å…¬å…±åŒºåŸŸ / ä¸æŒ‡å®š</option>
                            <option v-for="room in rooms" :key="room.name" :value="room.name">{{ room.name }}</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="text-xs font-bold text-gray-500">ç»´ä¿®è¯´æ˜</label>
                        <input v-model="newExpense.description" class="w-full border p-2 rounded mt-1" placeholder="ä¾‹å¦‚ï¼š101å®¤æ°´é¾™å¤´æ¼æ°´ï¼Œæ›´æ¢è´¹ç”¨">
                    </div>
                    
                    <div>
                        <label class="text-xs font-bold text-gray-500">æ”¯å‡ºé‡‘é¢</label>
                        <input type="number" v-model.number="newExpense.amount" class="w-full border p-2 rounded mt-1 font-mono text-lg text-red-600" placeholder="0.00">
                    </div>
                    
                    <button @click="addExpenseRecord" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded shadow font-medium transition-transform active:scale-95">
                        è®°å½•ç»´ä¿®æ”¯å‡º
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-8">
        <div class="p-4 border-b bg-yellow-50 flex justify-between items-center">
            <h3 class="font-bold text-gray-700"><i class="fas fa-history text-yellow-500 mr-2"></i> æ°´è´¹/ç‡ƒæ°”è´¹/ç‰©ä¸šè´¹ å†å²è´¦å• (å¾…æ”¶è®°å½•)</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-100 text-gray-500">
                    <tr>
                        <th class="p-3 w-20">æ—¥æœŸ</th>
                        <th class="p-3 w-20">ç±»å‹</th>
						<th class="p-3 w-45">å‘¨æœŸ</th>
                        <th class="p-3 text-right w-20">æ€»é‡‘é¢</th>
                        <th class="p-3">åˆ†æ‘Šè¯¦æƒ… (æˆ¿é—´: ä»½é¢)</th>
                        <th class="p-3 text-center w-20">çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-for="(bill, index) in bills" :key="bill.id" :class="{'bg-green-50': bill.settled, 'hover:bg-gray-50': !bill.settled}">
                        <td class="p-3">{{ bill.date }}</td>
                        <td class="p-3 font-medium">{{ bill.type }}</td>
						<td class="p-3 font-medium">{{ bill.billingStartDate }} to {{ bill.billingEndDate }}</td>
                        <td class="p-3 font-mono text-right">Â¥{{ bill.amount }}</td>
                        <td class="p-3 text-xs text-gray-600">
                            <span v-for="(share, roomName) in calculateWeightedShares(bill)" :key="roomName" class="mr-3">
                                <span class="font-bold">{{ roomName }}</span>: Â¥{{ share.toFixed(1) }} 
								<span class="font-bold"></span> 
                                <span v-if="!rooms.find(r => r.name === roomName)?.tenant" class="text-red-400">(å·²é€€ç§Ÿ)</span>
                            </span>
                        </td>
                        <td class="p-3 text-center">
                            <span v-if="bill.settled" class="text-green-600 font-bold"><i class="fas fa-check-circle"></i> å·²ç»“æ¸…</span>
                            <button v-else @click="toggleBillSettled(index)" class="bg-red-100 text-red-600 px-2 py-0.5 rounded text-xs hover:bg-red-200">
                                æœªç»“æ¸… (ç‚¹æ­¤æ ‡è®°)
                            </button>
                        </td>
                    </tr>
                    <tr v-if="bills.length === 0"><td colspan="5" class="p-4 text-center text-gray-400">æš‚æ— å†å²è´¦å•</td></tr>
                </tbody>
            </table>
        </div>
    </div>


    <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-12">
        <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
            <h3 class="font-bold text-gray-700">ğŸ“œ æˆ¿ç§Ÿ/ç»´ä¿® æ”¶æ”¯æµæ°´</h3>
            <button @click="resetData" class="text-xs text-red-300 hover:text-red-500">
                <i class="fas fa-trash-alt mr-1"></i>æ¸…ç©ºæ”¶æ”¯æµæ°´åŠè´¦å•
            </button>
        </div>
        <table class="w-full text-sm text-left">
            <thead class="bg-gray-100 text-gray-500">
                <tr>
                    <th class="p-3 w-24">æ—¥æœŸ</th>
                    <th class="p-3 w-24">ç±»å‹</th>
                    <th class="p-3">è¯¦æƒ…</th>
                    <th class="p-3 text-right w-24">è´¦æœ¬é‡‘é¢</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                <tr v-for="(record, index) in records" :key="index" class="hover:bg-gray-50">
                    <td class="p-3 text-gray-500">{{ record.date }}</td>
                    <td class="p-3">
                        <span :class="record.type === 'æ”¶å…¥' ? 'bg-green-100 text-green-700' : (record.type === 'æ”¯å‡º' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-500')" class="px-2 py-0.5 rounded text-xs font-bold">
                            {{ record.type }}
                        </span>
                    </td>
                    <td class="p-3">
                        <div class="font-medium text-gray-800">{{ record.title }}</div>
                        <div class="text-xs text-gray-500 mt-0.5">{{ record.desc }}</div>
                    </td>
                    <td class="p-3 text-right font-mono" :class="record.amount > 0 ? 'text-green-600 font-bold' : (record.amount < 0 ? 'text-red-600 font-bold' : 'text-gray-400')">
                        {{ record.amount !== 0 ? (record.amount > 0 ? '+' : '') + record.amount : '-' }}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div v-if="showModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4 text-gray-800">ç¼–è¾‘ä¿¡æ¯</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">æˆ¿é—´åç§°</label>
                    <input v-model="editForm.name" class="w-full border-2 border-gray-200 p-2 rounded focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ç§Ÿå®¢å§“å</label>
                    <input v-model="editForm.tenant" class="w-full border-2 border-gray-200 p-2 rounded focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">æœˆç§Ÿé‡‘ (å…ƒ)</label>
                    <input v-model.number="editForm.rent" type="number" class="w-full border-2 border-gray-200 p-2 rounded focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">èµ·ç§Ÿ/å…¥ä½æ—¥æœŸ</label>
                    <input v-model="editForm.startDate" type="date" class="w-full border-2 border-gray-200 p-2 rounded focus:border-blue-500 outline-none">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button @click="showModal = false" class="px-5 py-2 rounded text-gray-600 hover:bg-gray-100">å–æ¶ˆ</button>
                <button @click="saveRoom" class="px-5 py-2 bg-blue-600 text-white rounded shadow hover:bg-blue-700">ä¿å­˜ä¿¡æ¯</button>
            </div>
        </div>
    </div>
    
    <div v-if="showRentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-green-600 flex items-center">
                <i class="fas fa-money-bill-wave mr-2"></i> ç™»è®° {{ rentForm.roomName }} æ”¶ç§Ÿ
            </h3>
            <div class="space-y-4 text-gray-700">
                <p>ç§Ÿå®¢: **{{ rentForm.tenantName }}**</p>
                <p>é‡‘é¢: **Â¥{{ rentForm.amount }}** (3ä¸ªæœˆ)</p>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">æ”¶ç§Ÿæ—¥æœŸ</label>
                    <input v-model="rentForm.date" type="date" class="w-full border-2 border-gray-200 p-2 rounded focus:border-green-500 outline-none">
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button @click="showRentModal = false" class="px-5 py-2 rounded text-gray-600 hover:bg-gray-100">å–æ¶ˆ</button>
                <button @click="confirmCollectRent" class="px-5 py-2 bg-green-600 text-white rounded shadow hover:bg-green-700">ç¡®è®¤è®°å½•</button>
            </div>
        </div>
    </div>

    <div v-if="showCheckoutModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg transform transition-all scale-100">
            <h3 class="text-xl font-bold mb-4 text-red-600 flex items-center">
                <i class="fas fa-file-invoice-dollar mr-2"></i> {{ checkoutRoom.name }} é€€ç§Ÿç»“ç®—å•
            </h3>
            
            <div class="space-y-4 text-gray-700 border p-4 rounded-lg bg-gray-50">
                <h4 class="font-bold text-sm text-gray-800">1. ç§Ÿé‡‘/æŠ¼é‡‘æé†’</h4>
                <div class="text-sm border-b pb-2">
                    <p>ç§Ÿå®¢: **{{ checkoutRoom.tenant }}**</p>
                    <p>ä¸Šæ¬¡æ”¶ç§Ÿåˆ°æœŸæ—¥: **{{ getNextPayDate(checkoutRoom.startDate) }}** (è¯·æ ¹æ®å®é™…é€€ç§Ÿæ—¥è®¡ç®—åº”é€€ç§Ÿé‡‘åŠæŠ¼é‡‘)</p>
                </div>

                <h4 class="font-bold text-sm text-gray-800 flex justify-between items-center">
                    2. æœªç»“æ¸…çš„å…¬å…±è´¹ç”¨ (åŠ æƒå‡æ‘Š)
                    <span class="text-lg text-red-600 font-bold">Â¥{{ checkoutUnpaidAmount.toFixed(1) }}</span>
                </h4>
                
                <div v-if="unsettledBillsForCheckout.length > 0" class="text-xs bg-red-50 p-3 rounded-lg border border-red-200 max-h-40 overflow-y-auto">
                    <p class="font-bold text-red-700 mb-1">è¯¥ç§Ÿå®¢éœ€æ‰¿æ‹…ä»¥ä¸‹æœªç»“æ¸…è´¦å•ï¼š</p>
                    <ul class="space-y-1">
                        <li v-for="bill in unsettledBillsForCheckout" :key="bill.id" class="flex justify-between border-b last:border-b-0 py-0.5">
                            <span class="text-gray-700">{{ bill.type }} ({{ bill.date }}, å‘¨æœŸ: {{bill.billingStartDate}}~{{bill.billingEndDate}})</span>
                            <span class="font-mono font-bold text-red-700">Â¥{{ bill.share.toFixed(1) }}</span>
                        </li>
                    </ul>
                </div>
                <div v-else class="text-sm text-green-600 p-2 bg-green-50 rounded">
                    <i class="fas fa-thumbs-up"></i> **æ­å–œï¼š** è¯¥ç§Ÿå®¢åä¸‹æ— æœªç»“æ¸…çš„æ°´ç”µ/ç‰©ä¸šè´¦å•ï¼
                </div>
            </div>

            <div class="mt-6 flex justify-between space-x-3">
                <button @click="showCheckoutModal = false" class="px-5 py-2 rounded text-gray-600 hover:bg-gray-100">å–æ¶ˆ/è¿”å›</button>
                <button @click="confirmCheckout" class="px-5 py-2 bg-red-600 text-white rounded shadow hover:bg-red-700 font-bold">
                    ç¡®è®¤å·²æ¸…ç®—å¹¶é€€ç§Ÿ
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    new Vue({
        el: '#app',
        data: {
            showModal: false,
            showRentModal: false,
            showCheckoutModal: false,
            editingIndex: 0,
            checkoutIndex: null,
            checkoutRoom: {},
            editForm: {},
            
            rentForm: {
                index: null,
                roomName: '',
                tenantName: '',
                amount: 0,
                date: new Date().toISOString().slice(0, 10)
            },

            // åˆå§‹æ•°æ®ç»“æ„ (æ³¨æ„ï¼šlocalStorage é”®å·²æ›´æ–°ï¼Œä»¥é˜²æ—§æ•°æ®ç»“æ„å†²çª)
            rooms: JSON.parse(localStorage.getItem('house_v5_rooms')) || [
                { name: '101å®¤', tenant: '', rent: 1500, startDate: '' },
                { name: '102å®¤', tenant: '', rent: 1600, startDate: '' },
                { name: '103å®¤', tenant: '', rent: 1550, startDate: '' },
                { name: '104å®¤', tenant: '', rent: 1400, startDate: '' }
            ],
            records: JSON.parse(localStorage.getItem('house_v5_records')) || [],
            bills: JSON.parse(localStorage.getItem('house_v5_bills')) || [],
            
            newBill: { 
                type: 'æ°´è´¹', 
                amount: '', 
                date: new Date().toISOString().slice(0, 10), 
                billingStartDate: '', // æ–°å¢ï¼šè´¦å•å‘¨æœŸå¼€å§‹
                billingEndDate: '',   // æ–°å¢ï¼šè´¦å•å‘¨æœŸç»“æŸï¼ˆä¸å«ï¼‰
                sharedBy: [] 
            },
            
            newExpense: { type: 'ç»´ä¿®', amount: '', date: new Date().toISOString().slice(0, 10), roomName: '', description: '' }
        },
        filters: {
            numberFormat(value) { return parseFloat(value).toLocaleString('zh-CN', { minimumFractionDigits: 0 }); }
        },
        watch: {
            // ä¿®å¤ï¼šç¡®ä¿æˆ¿é—´ä¿¡æ¯æŒä¹…åŒ–ï¼Œé”®åç»Ÿä¸€
            rooms: { 
                handler() { 
                    localStorage.setItem('house_v5_rooms', JSON.stringify(this.rooms)); 
                    this.updateSharedBy(); 
                }, 
                deep: true 
            },
            records: { handler() { localStorage.setItem('house_v5_records', JSON.stringify(this.records)); }, deep: true },
            bills: { handler() { localStorage.setItem('house_v5_bills', JSON.stringify(this.bills)); }, deep: true },
            'newBill.date': function(newVal) { if (!newVal) this.newBill.date = new Date().toISOString().slice(0, 10); },
            'newExpense.date': function(newVal) { if (!newVal) this.newExpense.date = new Date().toISOString().slice(0, 10); }
        },
        mounted() { 
            this.updateSharedBy();
            // ç¡®ä¿æ—¥æœŸé»˜è®¤å€¼
            this.newBill.billingStartDate = this.getPreviousMonthDate();
            this.newBill.billingEndDate = new Date().toISOString().slice(0, 10);
        },
        computed: {
            totalIncome() { return this.records.filter(r => r.amount > 0).reduce((sum, r) => sum + r.amount, 0); },
            totalExpense() { return Math.abs(this.records.filter(r => r.amount < 0).reduce((sum, r) => sum + r.amount, 0)); },
            
            // ç»“ç®—æ—¶è®¡ç®—æœªç»“æ¸…çš„å…¬å…±è´¹ç”¨æ€»é¢ï¼ˆä½¿ç”¨åŠ æƒé€»è¾‘ï¼‰
            unsettledBillsForCheckout() {
                if (this.checkoutIndex === null) return [];
                const roomName = this.rooms[this.checkoutIndex].name;
                
                return this.bills
                    .filter(bill => !bill.settled && bill.sharedBy.includes(roomName))
                    .map(bill => {
                        // ä½¿ç”¨æ–°çš„åŠ æƒè®¡ç®—å‡½æ•°
                        const shares = this.calculateWeightedShares(bill);
                        return { 
                            id: bill.id, 
                            type: bill.type, 
                            date: bill.date, 
                            share: shares[roomName] || 0,
                            billingStartDate: bill.billingStartDate,
                            billingEndDate: bill.billingEndDate
                        };
                    })
                    .filter(bill => bill.share > 0); // ç¡®ä¿ä»½é¢å¤§äº 0 
            },
            checkoutUnpaidAmount() {
                return this.unsettledBillsForCheckout.reduce((sum, bill) => sum + bill.share, 0);
            }
        },
        methods: {
            // --- å®ç”¨å·¥å…· ---
            getDaysBetween(date1, date2) {
                const oneDay = 24 * 60 * 60 * 1000;
                const d1 = new Date(date1);
                const d2 = new Date(date2);
                return Math.max(0, Math.round(Math.abs((d2 - d1) / oneDay)));
            },
            getPreviousMonthDate() {
                const d = new Date();
                d.setMonth(d.getMonth() - 1);
                return d.toISOString().slice(0, 10);
            },
            
            // --- åŠ æƒåˆ†æ‘Šæ ¸å¿ƒé€»è¾‘ ---
            calculateWeightedShares(bill) {
                if (!bill.billingStartDate || !bill.billingEndDate || bill.amount <= 0 || bill.sharedBy.length === 0) return {};

                const billStart = new Date(bill.billingStartDate);
                const billEnd = new Date(bill.billingEndDate);
                
                // è´¦å•æ€»å¤©æ•°ï¼ˆä¸å«ç»“æŸæ—¥ï¼‰
                const totalBillDays = this.getDaysBetween(billStart, billEnd);
                if (totalBillDays <= 0) return {};
                
                let totalWeight = 0;
                let roomWeights = {};

                // 1. è®¡ç®—æ¯ä¸ªæˆ¿é—´çš„æƒé‡ï¼ˆå…¥ä½å¤©æ•°ï¼‰
                bill.sharedBy.forEach(roomName => {
                    const room = this.rooms.find(r => r.name === roomName);
                    
                    // è·å–å…¥ä½æ—¥æœŸï¼Œå¦‚æœå·²é€€ç§Ÿï¼Œéœ€è¦è€ƒè™‘é€€ç§Ÿæ—¥æœŸï¼Œä½† V5 æš‚ä¸è®°å½•é€€ç§Ÿæ—¥ï¼Œä»…ä½¿ç”¨ startDate
                    const tenantStartDate = room.startDate ? new Date(room.startDate) : billStart;
                    
                    // å®é™…æ‰¿æ‹…å¼€å§‹æ—¥æœŸï¼šå– è´¦å•å¼€å§‹æ—¥æœŸ å’Œ ç§Ÿå®¢å…¥ä½æ—¥æœŸ ä¸­è¾ƒæ™šçš„ä¸€ä¸ª
                    const effectiveStart = new Date(Math.max(billStart, tenantStartDate));
                    
                    // å®é™…æ‰¿æ‹…ç»“æŸæ—¥æœŸï¼šå– è´¦å•ç»“æŸæ—¥æœŸ
                    const effectiveEnd = billEnd; 

                    // è®¡ç®—æœ‰æ•ˆå¤©æ•°
                    const days = this.getDaysBetween(effectiveStart, effectiveEnd);
                    
                    roomWeights[roomName] = days;
                    totalWeight += days;
                });
                
                // 2. æ ¹æ®æƒé‡è®¡ç®—å®é™…åˆ†æ‘Šé‡‘é¢
                let shares = {};
                if (totalWeight > 0) {
                    bill.sharedBy.forEach(roomName => {
                        shares[roomName] = (bill.amount * roomWeights[roomName]) / totalWeight;
                    });
                }
                
                // 3. æ£€æŸ¥æ˜¯å¦æœ‰æœªåˆ†æ‘Šé‡‘é¢ï¼ˆæ€»ä»½é¢å¯èƒ½ä¸ç­‰äºæ€»é‡‘é¢ due to rounding/unshared daysï¼‰
                const totalShared = Object.values(shares).reduce((sum, share) => sum + share, 0);
                const unallocatedAmount = bill.amount - totalShared;

                // å‰©ä½™æœªåˆ†æ‘Šé‡‘é¢å¦‚ä½•å¤„ç†ï¼Ÿ
                // ç®€å•çš„ç­–ç•¥ï¼šå¦‚æœæ‰€æœ‰å¤©æ•°éƒ½è¢«è¦†ç›– (totalWeight == totalBillDays * bill.sharedBy.length)ï¼Œ
                // é‚£ä¹ˆæœªåˆ†æ‘Šé‡‘é¢åº”è¯¥å½’äºæˆ¿ä¸œï¼ˆæœªç§Ÿå‡ºçš„å¤©æ•°ï¼‰ï¼Œä½†ç›®å‰æˆ‘ä»¬è®©å®ƒä¿ç•™åœ¨ sharedBy åˆ—è¡¨ä¸­ã€‚
                // å¦‚æœéœ€è¦ä¸¥æ ¼å‡æ‘Šï¼Œåˆ™éœ€è¦æ›´å¤æ‚çš„å››èˆäº”å…¥æˆ–ä½™é¢åˆ†é…é€»è¾‘ã€‚
                // æš‚æ—¶ä¸åˆ†é… unallocatedAmountï¼Œè®©è®¡ç®—ç»“æœä¿æŒç²¾ç¡®ï¼Œç¡®ä¿åˆ†æ‘Šæ€»å’Œ = æ€»é‡‘é¢ã€‚
                
                // ç”±äºæµ®ç‚¹æ•°é—®é¢˜ï¼Œéœ€è¦ç¡®ä¿æ€»ä»½é¢ç­‰äºæ€»é‡‘é¢
                if (Object.keys(shares).length > 0) {
                    const factor = bill.amount / totalShared;
                    Object.keys(shares).forEach(roomName => {
                        shares[roomName] = shares[roomName] * factor; // å¼ºåˆ¶æ€»å’Œä¸º bill.amount
                    });
                }


                return shares;
            },
            
            updateSharedBy() {
                this.newBill.sharedBy = this.rooms
                    .filter(room => room.tenant)
                    .map(room => room.name);
            },
            getNextPayDate(startDate) {
                if (!startDate) return '-';
                let start = new Date(startDate);
                let now = new Date();
                let nextPay = new Date(start);
                while (nextPay <= now) nextPay.setMonth(nextPay.getMonth() + 3);
                return nextPay.toISOString().slice(0, 10);
            },
            
            // --- æˆ¿é—´å’Œå…¥ä½ç®¡ç† ---
            editRoom(index) { 
                this.editingIndex = index; 
                // ä½¿ç”¨ JSON.parse(JSON.stringify()) ç¡®ä¿æ·±åº¦å¤åˆ¶ï¼Œé˜²æ­¢ç›´æ¥ä¿®æ”¹ rooms
                this.editForm = JSON.parse(JSON.stringify(this.rooms[index])); 
                this.showModal = true; 
            },
            saveRoom() { 
                // ä¿®æ­£ï¼šä¿å­˜æ—¶ç›´æ¥æ›´æ–° rooms æ•°ç»„
                this.$set(this.rooms, this.editingIndex, this.editForm);
                this.showModal = false; 
                this.updateSharedBy(); 
            },

            // --- æ”¶ç§Ÿç®¡ç† ---
            openRentModal(index) {
                let r = this.rooms[index];
                if (!r.tenant) return alert('è¯¥æˆ¿é—´æš‚æ— ç§Ÿå®¢ã€‚');
                
                this.rentForm = {
                    index: index,
                    roomName: r.name,
                    tenantName: r.tenant,
                    amount: r.rent * 3,
                    date: new Date().toISOString().slice(0, 10)
                };
                this.showRentModal = true;
            },
            confirmCollectRent() {
                const { roomName, tenantName, amount, date } = this.rentForm;
                
                if (!date) return alert('è¯·é€‰æ‹©æ”¶ç§Ÿæ—¥æœŸã€‚');

                this.records.unshift({ 
                    date: date, 
                    type: 'æ”¶å…¥', 
                    title: `${roomName} æˆ¿ç§Ÿæ”¶å…¥`, 
                    desc: `${tenantName} (3ä¸ªæœˆ)`, 
                    amount: amount 
                });
                
                this.showRentModal = false;
                alert(`æ”¶ç§Ÿè®°å½•å·²æ·»åŠ : ${roomName} Â¥${amount}ï¼Œæ—¥æœŸ ${date}`);
            },

            // --- è´¦å•å’Œæ”¯å‡ºç®¡ç† ---
            addBill() {
                if (!this.newBill.amount || this.newBill.amount <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢");
                if (!this.newBill.date || !this.newBill.billingStartDate || !this.newBill.billingEndDate) return alert("è¯·å®Œæ•´å¡«å†™è´¦å•å’Œå‘¨æœŸæ—¥æœŸ");
                if (this.newBill.sharedBy.length === 0) return alert("è¯·é€‰æ‹©åˆ†æ‘Šæˆ¿é—´");
                
                // è´¦å•æ€»å¤©æ•°æ ¡éªŒ
                if (new Date(this.newBill.billingStartDate) >= new Date(this.newBill.billingEndDate)) return alert("å‘¨æœŸå¼€å§‹æ—¥æœŸå¿…é¡»æ—©äºå‘¨æœŸç»“æŸæ—¥æœŸ");

                // è®¡ç®—åŠ æƒä»½é¢ï¼Œç”¨äºé€šçŸ¥
                const shares = this.calculateWeightedShares(this.newBill);
                const shareText = Object.entries(shares).map(([r, s]) => `${r}: Â¥${s.toFixed(1)}`).join(', ');

                this.bills.unshift({
                    id: Date.now(),
                    date: this.newBill.date,
                    type: this.newBill.type,
                    amount: this.newBill.amount,
                    sharedBy: [...this.newBill.sharedBy],
                    billingStartDate: this.newBill.billingStartDate,
                    billingEndDate: this.newBill.billingEndDate,
                    settled: false
                });
                
                this.records.unshift({
                    date: this.newBill.date,
                    type: 'é€šçŸ¥',
                    title: `${this.newBill.type} è´¦å•ç”Ÿæˆ (Â¥${this.newBill.amount})`,
                    amount: 0,
                    desc: `å‘¨æœŸ ${this.newBill.billingStartDate}~${this.newBill.billingEndDate}ã€‚åŠ æƒåˆ†æ‘Šè¯¦æƒ…ï¼š${shareText}`
                });

                // é‡ç½®è¡¨å•
                this.newBill.amount = '';
                this.newBill.date = new Date().toISOString().slice(0, 10);
                this.newBill.billingStartDate = this.getPreviousMonthDate();
                this.newBill.billingEndDate = new Date().toISOString().slice(0, 10);
                this.updateSharedBy();
            },
            
            addExpenseRecord() {
                if (!this.newExpense.amount || this.newExpense.amount <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆæ”¯å‡ºé‡‘é¢");
                if (!this.newExpense.description) return alert("è¯·è¾“å…¥ç»´ä¿®è¯´æ˜");
                if (!this.newExpense.date) return alert("è¯·é€‰æ‹©æ”¯å‡ºæ—¥æœŸ");
                
                const roomText = this.newExpense.roomName ? `[${this.newExpense.roomName}] ` : '[å…¬å…±åŒºåŸŸ] ';
                
                this.records.unshift({ 
                    date: this.newExpense.date, 
                    type: 'æ”¯å‡º', 
                    title: `ç»´ä¿®æ”¯å‡º`, 
                    amount: -Math.abs(this.newExpense.amount),
                    desc: `${roomText} ${this.newExpense.description}`
                });

                this.newExpense.amount = '';
                this.newExpense.roomName = '';
                this.newExpense.description = '';
                this.newExpense.date = new Date().toISOString().slice(0, 10);
            },
            
            toggleBillSettled(index) {
                this.bills[index].settled = !this.bills[index].settled;
            },

            // --- é€€ç§Ÿç®¡ç† ---
            openCheckoutModal(index) {
                this.checkoutIndex = index;
                this.checkoutRoom = { ...this.rooms[index] };
                this.showCheckoutModal = true;
            },

            confirmCheckout() {
                if (this.checkoutUnpaidAmount > 0) {
                    if (!confirm(`è­¦å‘Šï¼šè¯¥ç§Ÿå®¢å°šæœ‰ Â¥${this.checkoutUnpaidAmount.toFixed(1)} æœªç»“æ¸…è´¹ç”¨ã€‚\nç¡®è®¤å·²å¤„ç†å®Œæ¯•å¹¶ç»§ç»­é€€ç§Ÿå—ï¼Ÿ`)) {
                        return;
                    }
                }
                
                const roomName = this.rooms[this.checkoutIndex].name;

                // 1. æ¸…ç†æˆ¿é—´ä¿¡æ¯ (é‡è¦ï¼šç§Ÿå®¢å·²é€€ï¼Œä½† room.name ä»ç„¶æ˜¯åˆ†æ‘Šçš„ key)
                this.$set(this.rooms, this.checkoutIndex, {
                    ...this.rooms[this.checkoutIndex],
                    tenant: '',
                    startDate: '', // æ¸…ç©ºå…¥ä½æ—¥æœŸï¼Œä½†ä¿ç•™ç§Ÿé‡‘/åç§°
                });
                
                // 2. æ›´æ–°è´¦å•ï¼šç§»é™¤å·²é€€ç§Ÿæˆ¿é—´çš„åˆ†æ‘Šæƒé™ï¼ˆå³ä» sharedBy åˆ—è¡¨ä¸­ç§»é™¤ï¼‰
                this.bills.forEach(bill => {
                    if (!bill.settled && bill.sharedBy.includes(roomName)) {
                        bill.sharedBy = bill.sharedBy.filter(name => name !== roomName);
                        // å¦‚æœç§»é™¤åå…±äº«åˆ—è¡¨ä¸ºç©ºï¼Œåˆ™æ ‡è®°ä¸ºå·²ç»“æ¸…
                        if (bill.sharedBy.length === 0) {
                            bill.settled = true;
                        }
                    }
                });

                // 3. è®°å½•é€€ç§Ÿæµæ°´ï¼ˆé€šçŸ¥ï¼‰
                this.records.unshift({
                    date: new Date().toISOString().slice(0,10),
                    type: 'é€šçŸ¥',
                    title: `${roomName} é€€ç§Ÿå®Œæˆ`,
                    amount: 0,
                    desc: `${this.checkoutRoom.tenant} å·²é€€ç§Ÿã€‚ç»“ç®—æœªç»“è´¹ç”¨ Â¥${this.checkoutUnpaidAmount.toFixed(1)}ã€‚`
                });

                this.showCheckoutModal = false;
                this.checkoutIndex = null;
                this.updateSharedBy();
                alert(`æˆ¿é—´ ${roomName} å·²æˆåŠŸåŠç†é€€ç§Ÿã€‚`);
            },
            
            // --- æ•°æ®ç®¡ç† ---
            downloadData() {
                const data = { rooms: this.rooms, records: this.records, bills: this.bills };
                const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `æˆ¿ä¸œæ•°æ®_v5_${new Date().toISOString().slice(0,10)}.json`; a.click();
            },
            uploadData(e) {
                const r = new FileReader(); 
                r.onload = (e) => { 
                    try { 
                        const d = JSON.parse(e.target.result); 
                        if(confirm('ç¡®å®šè¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) { 
                            this.rooms = d.rooms || this.rooms; 
                            this.records = d.records || [];
                            this.bills = d.bills || [];
                            alert("æ•°æ®æ¢å¤æˆåŠŸï¼");
                        } 
                    } catch(err){ alert("æ–‡ä»¶è§£æå¤±è´¥"); } 
                }; 
                r.readAsText(e.target.files[0]); 
                e.target.value = '';
            },
            
            resetData() { 
                if(confirm('è­¦å‘Šï¼šç¡®å®šæ¸…ç©ºæ‰€æœ‰æ”¶æ”¯æµæ°´å’Œæ°´ç”µ/ç‰©ä¸šè´¦å•å†å²å—ï¼Ÿï¼ˆæˆ¿é—´ä¿¡æ¯å’Œç§Ÿå®¢ä¿¡æ¯å°†ä¿ç•™ï¼‰')) {
                    localStorage.removeItem('house_v5_records'); 
                    localStorage.removeItem('house_v5_bills'); 
                    
                    this.records = [];
                    this.bills = [];
                    alert("æ”¶æ”¯æµæ°´å’Œè´¦å•å·²æ¸…ç©ºï¼Œæˆ¿é—´å’Œç§Ÿå®¢ä¿¡æ¯å·²ä¿ç•™ã€‚");
                } 
            }
        }
    });
</script>
</body>
</html>